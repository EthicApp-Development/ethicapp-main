"use strict";var app=angular.module("Rubrica",["ui.bootstrap","btford.socket-io","timer"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("RubricaController",["$scope","$http","$socket","$uibModal",function(a,b,c,d){var e=a;e.criterios=[],e.reports=[],e.report=null,e.selectedIndex=-1,e.iteration=-1,e.myUid=-1,e.sesStatusses=["Lectura","Individual","An\xF3nimo","Grupal","Reporte",".","Evaluaci\xF3n de Pares","Finalizada"],e.canAnswer=!0,e.miters=0,e.commentError=!1,e.finished=!1,e.init=function(){e.getReports(),e.getRubrica(),c.on("stateChange",function(a){console.log("SOCKET.IO",a),a.ses==e.sesId&&e.getReports()}),c.on("reportChange",function(a){console.log("SOCKET.IO",a),a.ses==e.sesId&&e.getReports()}),c.on("reportReceived",function(a){console.log("SOCKET.IO",a),a.ses==e.sesId&&e.openReport(a)}),b({url:"data/instructions.json",method:"get"}).success(function(a){e.instructions=a})},e.getReports=function(){b({url:"get-ses-info",method:"post"}).success(function(a){e.iteration=a.iteration,e.sesId=a.id,e.myUid=a.uid,e.sesSTime=null==a.stime?null:new Date(a.stime),a.descr&&(e.sesDescr=4>e.iteration?a.descr.split("\n")[0]||a.descr:a.descr.split("\n")[1]||a.descr),b({url:"get-finished",method:"post",data:{status:e.iteration+2}}).success(function(a){a.finished&&(e.finished=!0)}),"M"==a.type&&(e.sesStatusses=["Individual","Grupal","Reporte","Evaluaci\xF3n de Pares","Finalizada"],e.miters=1),5>=e.iteration?b({url:"get-active-example-report",method:"post"}).success(function(a){e.reports=[a],e.report=a,e.selectedIndex=0,e.fillSelections()}):6==e.iteration?b({url:"get-paired-report",method:"post"}).success(function(a){e.reports=a,e.report=a[0],e.selectedIndex=0,e.fillSelections()}):7==e.iteration&&b({url:"get-my-report",method:"post"}).success(function(a){console.log(a),e.reports=[a],e.report=a,e.selectedIndex=0,e.getEvals(a.id)})})},e.selectReport=function(a){e.selectedIndex=a,e.report=e.reports[a]},e.getRubrica=function(){b({url:"get-rubrica",method:"post"}).success(function(a){e.criterios=a})},e.checkCriteria=function(a){return null!=a&&null!=a.id&&null!=a.select&&e.criterios.reduce(function(b,c){return null!=a.select[c.id]&&b},!0)},e.sendSelection=function(a){/*if(report.comment == "" || report.comment == null || report.comment.length < 5){
            self.commentError = true;
            return;
        }*/if(e.checkCriteria(a)){e.commentError=!1,a.dirty=!1,e.criterios.forEach(function(c){var d={cid:c.id,sel:a.select[c.id],rid:a.id};b({url:"send-criteria-selection",method:"post",data:d}).success(function(){console.log("ok")})});var c={rid:a.id,text:a.comment};if(b({url:"send-report-comment",method:"post",data:c}).success(function(){console.log("ok")}),a.status="SENT",5==e.iteration){e.canAnswer=!1;var d={rid:a.id};b({url:"get-criteria-answer",method:"post",data:d}).success(function(b){var c=e.reports.findIndex(function(b){return b.id==a.id});console.log(c),e.reports[c].truev={},b.forEach(function(a){e.reports[c].truev[a.cid]=a.selection})})}}},e.finishState=function(){if(!e.finished){if(e.reports.some(function(a){return"SENT"!=a.status}))return void f("Error","Debe terminar de responder todos los reportes");var a=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(a){var c={status:e.iteration+2};b({url:"record-finish",method:"post",data:c}).success(function(){e.finished=!0,console.log("FINISH")})}}},e.fillSelections=function(){e.reports.forEach(function(a){var c={rid:a.id};e.canAnswer=!0,b({url:"get-criteria-selection",method:"post",data:c}).success(function(b){a.select={},b.forEach(function(b){a.status="SENT",a.select[b.cid]=b.selection,5==e.iteration&&(e.canAnswer=!1)})}),b({url:"get-report-comment",method:"post",data:c}).success(function(b){a.comment=b.comment})})},e.getEvals=function(a){var c={repid:a};b({url:"get-report-result",method:"post",data:c}).success(function(a){e.answers=a}),b.post("get-criteria-selection-by-report",c).success(function(a){e.answersRubrica={},a.forEach(function(a){null==e.answersRubrica[a.uid]&&(e.answersRubrica[a.uid]={}),e.answersRubrica[a.uid][a.cid]=a.selection})})},e.getAvg=function(){if(null!=e.answers&&0!=e.answers.length){var a=e.answers.reduce(function(a,b){return a+b.val},0);return a/e.answers.length}},e.openReport=function(a){var c={rid:a.rid};b({url:"get-report",method:"post",data:c}).success(function(a){console.log(a),d.open({templateUrl:"templ/report-forward.html",controller:"ReportModalController",controllerAs:"vm",scope:e,resolve:{report:function b(){return a}}})})},e.selectCriterio=function(a,b){e.canAnswer&&(e.report.select[a]=b,e.report.dirty=!0)},e.openCriterio=function(a,b){var c=d.open({templateUrl:"templ/criterio-dialog.html",controller:"CriterioModalController",controllerAs:"vm",scope:e,resolve:{data:function c(){return{criterio:a,dis:b||!e.canAnswer||e.finished,res:b?b:e.report.select[a.id]||0}}}});c.result.then(function(b){e.selectCriterio(a.id,b)})};var f=function(a,b){d.open({template:"<div><div class=\"modal-header\"><i class=\"fa fa-close pull-right hoverable\" ng-click=\"$uibModalInstance.dismiss()\"></i> <h4>"+a+"</h4></div><div class=\"modal-body\"><p>"+b+"</p></div></div>"})};e.init()}]),app.controller("ReportModalController",["$scope","$uibModalInstance","report",function(a,b,c){var d=this;d.report=c,d.cancel=function(){b.dismiss("cancel")}}]),app.controller("CriterioModalController",["$scope","$uibModalInstance","data",function(a,b,c){var d=this;d.data=c,d.res=c.res,d.cancel=function(){b.dismiss("cancel")},d.done=function(){b.close(d.res)},d.select=function(a){d.data.dis||(d.res=a)}}]);
