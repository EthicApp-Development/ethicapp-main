"use strict";var app=angular.module("Editor",["ui.tree","timer"]);app.controller("EditorController",["$scope","$http","$timeout",function(a,b,c){var d=a;d.documents=[],d.selections=[],d.selectedDocument=0,d.numPages=0,d.docIdx={},d.editable=!1,d.orden=1,d.sesStatusses=["Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],rangy.init(),d.applier=rangy.createClassApplier("highlight"),d.secondaryApplier=rangy.createClassApplier("highlight-secondary"),d.init=function(){d.getSesInfo()},d.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(k){d.iteration=k.iteration,d.sesSTime=null==k.stime?null:new Date(k.stime),console.log(d.sesSTime),b({url:"get-documents",method:"post"}).success(function(l){d.documents=l,l.forEach(function(m,n){d.docIdx[m.id]=n}),d.renderAll()}),b({url:"pauta-editable",method:"post"}).success(function(l){d.editable=l.editable})})},d.selectText=function(){var k=window.getSelection(),l=rangy.serializeSelection(window,!0,$("#pdf-canvas-"+d.selectedDocument)[0]),m={text:k.toString(),length:k.toString().length,serial:l,document:d.selectedDocument,comment:"",expanded:!0,order:d.orden,status:"unsaved"};2>m.length||50<m.length||d.selections.push(m)},d.goToSerial=function(k,l,m){m=null==m?".highlight":m,d.selectedDocument=l;var n=angular.element(m);n=n.filter(function(o,q){return q.innerHTML==k}),console.log(n),0<n.length&&c(function(){return n[0].scrollIntoView()},100)},d.highlightSerial=function(k,l,m){console.log(k,l),m=null==m?d.applier:m;try{m.applyToRange(rangy.deserializeRange(k,$("#pdf-canvas-"+l)[0],document))}catch(n){console.log(k+" no se pudo highlightear!",n)}},d.renderAll=function(){d.numPages=0,d.documents.forEach(function(k,l){g(k.path,l)})},d.selectPDF=function(k){d.selectedDocument=k},d.getIdeas=function(){b({url:"get-ideas",method:"post",data:{iteration:1}}).success(function(m){d.selections=[],m.forEach(function(n){var o={id:n.id,text:n.content,serial:n.serial,document:f(d.documents,n.docid),comment:n.descr,expanded:!1,order:n.orden+1,status:"saved"};d.selections.push(o)})})},d.sendIdea=function(k){var l={text:k.text,comment:k.comment,serial:k.serial,docid:d.documents[k.document].id,iteration:1,order:k.order-1};d.order=k.order,"unsaved"==k.status?b({url:"send-pauta-idea",method:"post",data:l}).success(function(m){"ok"==m.status&&(k.expanded=!1,k.status="saved",k.id=m.id)}):"dirty"==k.status&&null!=k.id&&(l.id=k.id,b({url:"update-pauta-idea",method:"post",data:l}).success(function(m){"ok"==m.status&&(k.expanded=!1,k.status="saved")}))},d.deleteIdea=function(k,l){if(null!=k.id){var m={id:k.id};b({url:"delete-idea",method:"post",data:m}).success(function(n){"ok"==n.status&&d.selections.splice(l,1)})}else d.selections.splice(l,1)},d.selTextChange=function(k){k.status="saved"==k.status?"dirty":k.status},d.checkAllSync=function(){return 0==d.selections.filter(function(k){return"saved"!=k.status}).length},d.setSelOrder=function(){if(d.checkAllSync()){var k=d.selections.map(function(m){return m.id});b({url:"set-ideas-orden",method:"post",data:{orden:k}}).success(function(m){"ok"==m.status&&console.log("Order saved")})}};var f=function arrayIndexOfId(k,l){return k.reduce(function(m,n,o){return n.id==l?o:m},-1)},g=function loadPdf(k,l){PDFJS.disableWorker=!0;var m=PDFJS.getDocument(k);m.then(function(n){return h(n,l)})},h=function renderPdf(k,l){for(var n,m=1;m<=k.numPages;m++)n=k.getPage(m).then(function(o){return j(o,l)}),d.numPages+=1},j=function renderPage(k,l){var n=k.getViewport(1.3),o=$("<canvas></canvas>"),q=o.get(0),r=q.getContext("2d");q.height=n.height,q.width=n.width;var s=$("#pdf-canvas-"+l);s.css("height",q.height+"px").css("width",q.width+"px"),s.append(o);var t=o.offset(),u=jQuery("<div></div>").addClass("textLayer").css("height",n.height+"px").css("width",n.width+"px");s.append(u),k.getTextContent({normalizeWhitespace:!0}).then(function(v){var w=new TextLayerBuilder(u.get(0),0);w.setTextContent(v);k.render({canvasContext:r,viewport:n,textLayer:w}).then(function(){d.numPages-=1,0==d.numPages&&(d.getIdeas(),$(".textLayer").html(function(){return this.innerHTML.replace(/\t/g," ")}))})})};d.init()}]);
