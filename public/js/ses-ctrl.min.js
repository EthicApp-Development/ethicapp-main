"use strict";

var adpp = angular.module("SesList", ["ui.bootstrap", 'btford.socket-io', 'angular-intro']);

adpp.factory("$socket", ["socketFactory", function (socketFactory) {
    return socketFactory();
}]);

adpp.controller("SesListController", ["$scope", "$http", "$socket", "$uibModal", "ngIntroService", function ($scope, $http, $socket, $uibModal, ngIntroService) {
    var self = $scope;
    self.sessions = [];
    self.sesOpen = false;
    self.invCode = "";
    self.showCodeError = false;
    self.routes = {
        L: "to-visor",
        M: "to-semantic",
        S: "to-select",
        E: "to-differential",
        R: "to-role",
        T: "to-diff",
        J: "to-role"
    };

    self.init = function () {
        self.updateSessions();
        $socket.on("stateChange", function (data) {
            console.log("SOCKET.IO", data);
            self.updateSessions();
        });
        self.showName();
    };

    self.showName = function () {
        $http.post("get-my-name").success(function (data) {
            self.username = data.name;
            self.mylang = data.lang;
            if (self.mylang=="english"){
                self.ses="Sesiones"
            }
            else{
                self.ses="Sessions"
            }
        });
    };

    self.updateSessions = function () {
        $http({ url: "get-session-list", method: "post" }).success(function (data) {
            self.sessions = data;
        });
    };

    self.openSes = function () {
        self.sesOpen = true;
    };

    self.enterCode = function () {
        if (self.checkCode(self.invCode.toLowerCase())) {
            var postdata = {
                code: self.invCode.toLowerCase(),
                device: self.getDeviceInfo()
            };
            $http.post("enter-session-code", postdata).success(function (data) {
                if (data.status == "ok") {
                    window.location.replace(data.redirect);
                } else {
                    $uibModal.open({
                        template: '<div><div class="modal-header"><h4>Error</h4></div><div class="modal-body">' + '<p>El código ingresado no es válido o la sesión no admite nuevos usuarios</p></div></div>'
                    });
                }
            });
        }
    };

    self.checkCode = function (code) {
        console.log(self.sessions, code);
        var s = self.sessions.find(function (e) {
            return e.code == code;
        });
        console.log(s);
        if (s == null) return true;
        var url = self.routes[s.type] + "?sesid=" + s.id;
        window.location.replace(url);
        return false;
    };

    self.changeLang = function () {
        var newlang = self.mylang == "english" ? "spanish" : "english";
        
        $http.post("update-lang", { lang: newlang }).success(function (data) {
            self.showName();
        });
        if (self.mylang=='spanish'){
            ngIntroService.setOptions(introOptionsSpan);
        }
        else{
            ngIntroService.setOptions(introOptionsEng);
        }
    };

    var introOptionsSpan = {
        steps: [{
            element: '#seslistdiv',
            intro: 'Aqui debajo se muestran todas las sesiones que tienes disponibles. Al apretar en una de ellas puedes ingresar a la actividad',
            position: "right"
        }, {
            element: "#codebox",
            intro: "Para ingresar a una nueva actividad, debes ingresar el código de una sesión que te entrega el/la profesor/a en este campo."
        }, {
            element: "#codeboxbtn",
            intro: "Usando este botón ingresas a la sesión indicada por el código"
        }, {
            element: '#changelang',
            intro: "Con este botón puedes cambiar el idioma. Using this button you can change the language",
            position: "left"
        }, {
            element: '#topbtnlist',
            intro: 'Finalmente usando el botón de ayuda puedes volver a ver esta ayuda y con el botón de salir puedes cerrar sesión.',
            position: "left"
        }],
        showStepNumbers: false,
        showBullets: false,
        exitOnOverlayClick: true,
        exitOnEsc: true,
        tooltipPosition: "auto",
        nextLabel: 'Siguiente',
        prevLabel: 'Anterior',
        skipLabel: 'Salir',
        doneLabel: 'Listo'
    };
    var introOptionsEng = {
        steps: [{
            element: '#seslistdiv',
            intro: 'Below are all the sessions you have available. By pressing on one of them you can enter the activity.',
            position: "right"
        }, {
            element: "#codebox",
            intro: "To enter a new activity, you must enter the code of a session that the teacher gives you in this field."
        }, {
            element: "#codeboxbtn",
            intro: "Using this button you enter the session indicated by the code."
        }, {
            element: '#changelang',
            intro: "Using this button you can change the language",
            position: "left"
        }, {
            element: '#topbtnlist',
            intro: 'Finally using the help button you can see this help again and with the exit button you can log out.',
            position: "left"
        }],
        showStepNumbers: false,
        showBullets: false,
        exitOnOverlayClick: true,
        exitOnEsc: true,
        tooltipPosition: "auto",
        nextLabel: 'Siguiente',
        prevLabel: 'Anterior',
        skipLabel: 'Salir',
        doneLabel: 'Listo'
    };
    if (self.mylang=='spanish'){
        ngIntroService.setOptions(introOptionsSpan);
    }
    else{
        ngIntroService.setOptions(introOptionsEng);
    }



    self.startTour = function () {
        ngIntroService.start();
    };

    self.getDeviceInfo = function () {
        var p = new UAParser();
        return (p.getDevice().type || "Desktop") + " / " + p.getOS().name + " / " + p.getBrowser().name;
    };

    self.init();
}]);
