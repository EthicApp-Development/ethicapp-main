"use strict";var app=angular.module("Select",["ui.bootstrap","timer","btford.socket-io","ui-notification","ngSanitize","ngMap"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SelectController",["$scope","$http","$socket","Notification","$uibModal","NgMap",function(a,b,d,f,g,h){var j=a;j.selectedQs=0,j.iteration=1,j.myUid=-1,j.questions=[],j.otherAnswsers={},j.answers={},j.anskey={},j.comments={},j.confidences={},j.optLabels=["A","B","C","D","E"],j.optConfidence=[0,25,50,75,100],j.sent={},j.teamUids=[],j.bottomMsg="",j.finished=!1,j.useConfidence=!1,j.useHints=!1,j.shared={},j.ansIter1={},j.ansIter2={},j.sesStatusses=["individual","anon","teamWork","finished"],j.lang="spanish",j.init=function(){j.getSesInfo(),d.on("stateChange",function(m){console.log("SOCKET.IO",m),m.ses==j.sesId&&window.location.reload()}),d.on("teamProgress",function(m){console.log("SOCKET.IO",m),m.ses==j.sesId&&m.tmid==j.teamId&&3==j.iteration&&j.updateTeam()}),d.on("updateOverlay",function(m){console.log("SOCKET.IO",m),m.qid==j.questions[j.selectedQs].id&&3==j.iteration&&j.shared.updateOverlayList()}),h.getMap().then(function(m){j.map=m}),j.getMe()},j.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(m){j.iteration=m.iteration+1,j.myUid=m.uid,j.sesName=m.name,j.sesId=m.id,j.sesSTime=m.stime,j.sesDescr=m.descr,j.useConfidence=null!=m.options&&m.options.includes("C"),j.useHints=null!=m.options&&m.options.includes("H"),j.useComments=null!=m.options&&m.options.includes("J");var n=new Set;1<j.iteration&&b({url:"get-team-selection",method:"post",data:{iteration:1}}).success(function(o){o.forEach(function(q){j.ansIter1[q.qid]=j.ansIter1[q.qid]||{},j.ansIter1[q.qid][q.uid]={answer:q.answer,comment:q.comment},n.add(q.uid)}),j.teamUids=Array.from(n),j.shared.updateOverlayList()}),2<j.iteration&&(b({url:"get-team-selection",method:"post",data:{iteration:2}}).success(function(o){o.forEach(function(q){j.ansIter2[q.qid]=j.ansIter2[q.qid]||{},j.ansIter2[q.qid][q.uid]={answer:q.answer,comment:q.comment},n.add(q.uid)}),j.teamUids=Array.from(n)}),j.updateTeam(),j.shared.updateOverlayList()),4<=j.iteration&&(j.finished=!0,j.loadAnskey()),0<j.iteration&&(j.loadQuestions(),j.loadAnswers())})},j.getMe=function(){b.post("get-my-name").success(function(m){j.lang=m.lang,j.updateLang(j.lang)})},j.updateTeam=function(){b({url:"get-team",method:"post"}).success(function(m){j.team={},j.teamstr=m.map(function(n){return n.name}).join(", "),m.forEach(function(n){j.team[n.id]=n.name}),0<m.length&&(j.teamId=m[0].tmid,j.teamProgress=m[0].progress,3==j.iteration&&j.selectQuestion(j.teamProgress))})},j.loadQuestions=function(){b({url:"get-questions",method:"post"}).success(function(m){j.questions=m,j.questions.forEach(function(n){n.options=n.options.split("\n"),n.map=k(n)}),j.shared.updateOverlayList()})};var k=function processMap(m){if(m.plugin_data&&m.plugin_data.startsWith("MAP")){var n=m.plugin_data.split(" ");return console.log(n),{center:"["+n[1]+", "+n[2]+"]",zoom:n[3],nav:"NAV"==n[4],edit:"EDIT"==n[4]||"EDIT"==n[5]}}return null};j.loadAnskey=function(){b({url:"get-anskey",method:"post"}).success(function(m){j.anskey={},m.forEach(function(n){j.anskey[n.id]=n})})},j.loadAnswers=function(){b({url:"get-answers",method:"post",data:{iteration:Math.min(3,j.iteration)}}).success(function(m){m.forEach(function(n){j.answers[n.qid]=n.answer,j.comments[n.qid]=n.comment,j.confidences[n.qid]=n.confidence,j.sent[n.qid]=!0})})},j.setAnswer=function(m,n){j.answers[m.id]=n,m.dirty=!0},j.selectQuestion=function(m){j.selectedQs=m,j.questions[m].plugin_data&&j.shared.updateOverlayList()},j.selectQuestionTab=function(m){if(3==j.iteration){console.log("Checking team answers");var n={qid:j.questions[j.selectedQs].id};b({url:"check-team-answer",method:"post",data:n}).success(function(o){"ok"==o.status?j.sendTeamProgress(m):"incomplete"==o.status?l("Error","Debe esperar a que todos los miembros del equipo respondan"):"different"==o.status?l("Error","Las respuestas de los miembros del equipo no coinciden"):"incorrect"==o.status&&!j.questions[j.selectedQs].hinted&&j.useHints?(l("Comentario",o.msg),j.questions[j.selectedQs].hinted=!0):j.questions[j.selectedQs].hinted||!j.useHints?j.sendTeamProgress(m):l("Actividad","Se alcanzo el final de la actividad")})}else j.questions[j.selectedQs].dirty?l("Error","No se ha enviado una respuesta a la pregunta"):j.selectQuestion(m)},j.nextQuestion=function(){if(3==j.iteration){console.log("Checking team answers");var m={qid:j.questions[j.selectedQs].id};b({url:"check-team-answer",method:"post",data:m}).success(function(n){"ok"==n.status?(j.sendTeamProgress(j.selectedQs+1),j.bottomMsg=""):"incomplete"==n.status?l("Error","Debe esperar a que todos los miembros del equipo respondan"):"different"==n.status?l("Error","Las respuestas de los miembros del equipo no coinciden"):"incorrect"==n.status&&!j.questions[j.selectedQs].hinted&&j.useHints?(l("Comentario",n.msg),j.questions[j.selectedQs].hinted=!0):j.questions[j.selectedQs].hinted||!j.useHints?(j.sendTeamProgress(j.selectedQs+1),j.bottomMsg=""):l("Actividad","Se alcanzo el final de la actividad")})}else j.questions[j.selectedQs].dirty?l("Error","No se ha enviado una respuesta a la pregunta"):j.selectedQs>=j.questions.length-1&&3!=j.iteration?l("Actividad","Se alcanzo el final de la actividad"):j.selectQuestion(j.selectedQs+1)},j.sendTeamProgress=function(m){var n={tmid:j.teamId,progress:m};b({url:"send-team-progress",method:"post",data:n}).success(function(o){"ok"==o.status&&console.log("Progress sent")})},j.prevQuestion=function(){return 0>=j.selectedQs?void l("Actividad","Se alcanzo el inicio de la actividad"):void(j.questions[j.selectedQs].dirty?l("Error","No se ha enviado una respuesta a la pregunta"):3!=j.iteration&&j.selectQuestion(j.selectedQs-1))},j.sendAnswer=function(m){if(null==j.answers[m.id]||-1==j.answers[m.id])return void l("Error","Debe seleccionar una alternativa");if(j.useComments&&(null==j.comments[m.id]||""==j.comments[m.id]))return void l("Error","Debe agregar un comentario");if(j.useConfidence&&null==j.confidences[m.id])return void l("Error","Debe agregar un grado de certeza");var n={qid:m.id,answer:j.answers[m.id],comment:j.comments[m.id],confidence:j.confidences[m.id],iteration:j.iteration};b({url:"send-answer",method:"post",data:n}).success(function(o){"ok"==o.status&&(j.sent[n.qid]=!0,m.dirty=!1)})};var l=function notify(m,n){g.open({template:"<div><div class=\"modal-header\"><h4>"+m+"</h4></div><div class=\"modal-body\"><p>"+n+"</p></div></div>"})};j.openComment=function(m){l("Comentario",m)},j.showInfo=function(){l("Factor Detonante",j.sesDescr,!1)},j.updateLang=function(m){b.get("data/"+m+".json").success(function(n){window.DIC=n})},j.changeLang=function(){j.lang="english"==j.lang?"spanish":"english",j.updateLang(j.lang)},j.init()}]),app.controller("GeoController",["$scope","$http","NgMap","$socket",function(a,b,d,f){var g=a;g.openRight=!1,g.rightTab="",g.mOverlays=[],g.sOverlays=[],g.selectedOverlay=null,g.editing=!1;var k=function toOverlay(s){return function(u){return{id:u.id,name:u.name,description:u.description+"\n"+m(u),color:s,type:u.type,fullType:o(u.type),geom:JSON.parse(u.geom)}}},m=function buildFooter(s){return 0==s.iteration?"Predefinido":s.uid==g.myUid?g.sesStatusses[s.iteration-1]+" - Propio":g.sesStatusses[s.iteration-1]+" - "+(g.team[s.uid]?g.team[s.uid]:"Anonimo "+s.uid)},n=function packOverlay(s){return{name:s.name,description:s.description,iteration:g.iteration,qid:null==g.questions[g.selectedQs]?-1:g.questions[g.selectedQs].id,type:s.type,geom:JSON.stringify(s.geom)}},o=function getFullType(s){return"M"===s?"marker":"P"===s?"polygon":"L"===s?"polyline":"R"===s?"rectangle":"C"===s?"circle":"I"===s?"image":void 0};g.clearOverlay=function(){g.newOverlay={name:"",description:"",color:"red",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},g.updateOverlayList=function(){if(g.mOverlays=[],g.sOverlays=[],!(2==g.iteration&&angular.equals(g.teamUids,[])||3<=g.iteration&&(null==g.team||angular.equals(g.team,{})))){var u=null==g.questions[g.selectedQs]?-1:g.questions[g.selectedQs].id;b.post("list-default-overlay",{qid:u}).success(function(x){var y=x.map(k("blue"));g.mOverlays=g.mOverlays.concat(y.filter(function(z){return"M"==z.type})),g.sOverlays=g.sOverlays.concat(y.filter(function(z){return"M"!=z.type}))});var v={qid:u,iteration:g.iteration};b.post("list-overlay",v).success(function(x){var y=x.map(k("red"));g.mOverlays=g.mOverlays.concat(y.filter(function(z){return"M"==z.type})),g.sOverlays=g.sOverlays.concat(y.filter(function(z){return"M"!=z.type}))});var w=["green","orange","violet","grey"];2==g.iteration&&g.teamUids.forEach(function(x,y){if(x!=g.myUid){b.post("list-team-overlay",{qid:u,iteration:1,uid:x}).success(function(A){var B=A.map(k(w[y%4]));g.mOverlays=g.mOverlays.concat(B.filter(function(C){return"M"==C.type})),g.sOverlays=g.sOverlays.concat(B.filter(function(C){return"M"!=C.type}))})}}),3<=g.iteration&&g.teamUids.forEach(function(x,y){if(x!=g.myUid){b.post("list-team-overlay",{qid:u,iteration:3,uid:x}).success(function(A){var B=A.map(k(w[y%4]));g.mOverlays=g.mOverlays.concat(B.filter(function(C){return"M"==C.type})),g.sOverlays=g.sOverlays.concat(B.filter(function(C){return"M"!=C.type}))})}})}},g.shared.updateOverlayList=function(){null!=g.map&&(google.maps.event.trigger(g.map,"resize"),g.map.infoWindows.iw.close(),g.updateOverlayList(),g.questions[g.selectedQs].map&&g.map.setOptions({draggable:g.questions[g.selectedQs].map.nav}))},g.onMapOverlayCompleted=function(s){g.editing=!0,g.map.mapDrawingManager[0].setDrawingMode(null),g.newOverlay.fullType=s.type,g.newOverlay.type="polyline"==s.type?"L":s.type[0].toUpperCase(),g.newOverlay.geom.position=s.overlay.getPosition?positionToArray(s.overlay.getPosition()):null,g.newOverlay.geom.radius=s.overlay.radius,g.newOverlay.geom.center=positionToArray(s.overlay.center),g.newOverlay.geom.path=s.overlay.getPath?mutiplePositionToArray(s.overlay.getPath()):null,g.newOverlay.geom.bounds=s.overlay.getBounds?boundsToArray(s.overlay.getBounds()):null,g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2"),s.overlay.setMap(null)},g.colorizeShape=function(s){g.map.shapes&&g.map.shapes.nshp&&(g.map.shapes.nshp.set("fillColor",s),g.map.shapes.nshp.set("strokeColor","dark"+s))},g.closeOverlay=function(){g.clearOverlay(),g.map.infoWindows.iw2.close()};var q=function updateOverlay(){var s="M"==g.newOverlay.type?g.map.markers.nmkr:g.map.shapes.nshp;g.newOverlay.geom.position=s.getPosition?positionToArray(s.getPosition()):null,g.newOverlay.geom.radius=s.radius,g.newOverlay.geom.center=positionToArray(s.center),g.newOverlay.geom.path=s.getPath?mutiplePositionToArray(s.getPath()):null,g.newOverlay.geom.bounds=s.getBounds?boundsToArray(s.getBounds()):null,g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2")};g.sendOverlay=function(){q(),b.post("add-overlay",n(g.newOverlay)).success(function(s){"ok"==s.status&&(g.closeOverlay(),g.updateOverlayList())})},g.clickOverlay=function(){g.selectOverlay(this.id)},g.selectOverlay=function(s){g.selectedOverlay=g.mOverlays.find(function(u){return u.id==s})||g.sOverlays.find(function(u){return u.id==s}),g.selectedOverlay.centroid=centroidAsLatLng(g.selectedOverlay.type,g.selectedOverlay.geom),g.map.panTo(g.selectedOverlay.centroid),g.map.showInfoWindow("iw")},g.googleSearch=function(){var s=this.getPlace();null==s||null==s.geometry||null==s.geometry.location||(g.map.mapDrawingManager[0].setDrawingMode(null),g.newOverlay.fullType="marker",g.newOverlay.type="M",g.newOverlay.geom.position=positionToArray(s.geometry.location),g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2"),g.map.panTo(s.geometry.location))},function init(){g.clearOverlay(),d.getMap().then(function(s){console.log("MAP cargado correctamente"),g.map=s,g.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),g.shared.updateOverlayList()}),f.on("update-overlay",function(s){s.sesid==g.sesId&&g.updateOverlayList()})}()}]),app.filter("trustHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),window.DIC=null,window.warnDIC={},app.filter("lang",function(){function a(b){if(null!=window.DIC)return window.DIC[b]?window.DIC[b]:(window.warnDIC[b]||(console.warn("Cannot find translation for ",b),window.warnDIC[b]=!0),b)}return a.$stateful=!0,a});var positionToArray=function(a){return null==a?null:[a.lat(),a.lng()]},mutiplePositionToArray=function(a){for(var f,b=[],d=0;d<a.getLength();d++)f=a.getAt(d),b.push(positionToArray(f));return b},boundsToArray=function(a){return[positionToArray(a.getSouthWest()),positionToArray(a.getNorthEast())]},avgCoord=function(a){for(var b=0,d=0,f=0;f<a.length;f++)b+=a[f][0],d+=a[f][1];return[b/a.length,d/a.length]},centroidAsLatLng=function(a,b){var d=centroid(a,b);return new google.maps.LatLng(d[0],d[1])},centroid=function(a,b){return"M"==a?b.position:"C"==a?b.center:"R"==a?avgCoord(b.bounds):"P"==a||"L"==a?avgCoord(b.path):null};
