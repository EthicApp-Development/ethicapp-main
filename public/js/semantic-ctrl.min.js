"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(c,i,d,a,g){var l=c;l.iteration=0,l.sesStatusses=[{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:6,name:"Evaluaci\xF3n de Pares"},{i:7,name:"Finalizada"}],l.documents=[],l.finished=!1,l.text="",l.sentences=[],l.highlight=[],l.disabledSents=[],l.originalTexts=[],l.originalSentences=[],l.sent={},l.writingReport=!1,l.followLeader=!1,l.leader=!1,l.writingReport=!1,l.views={},l.units=[],l.unitsIter1=[],l.unitsIter3=[],l.shared={},l.teamNames={},l.editing=-1,l.hgDocs={},l.misc={},l.init=function(){a.on("stateChange",function(a){console.log("SOCKET.IO",a),a.ses==l.sesId&&window.location.reload()}),a.on("updateTeam",function(a){l.teamId==a.tmid&&(!l.leader&&l.getUnits(),l.getTeamInfo())}),l.getSesInfo(),l.getUserInfo()},l.getSesInfo=function(){i({url:"get-ses-info",method:"post"}).success(function(a){l.iteration=a.iteration,l.myUid=a.uid,0<l.iteration&&2==l.myUid&&(l.iteration=1),l.sesName=a.name,l.sesId=a.id,a.descr&&(l.sesDescr=4>l.iteration?a.descr.split("\n")[0]||a.descr:a.descr.split("\n")[1]||a.descr),l.sesSTime=null==a.stime?null:new Date(a.stime),l.getDocuments(),3==l.iteration&&l.getTeamInfo(),3<=l.iteration&&l.getSimpleTeamInfo(),4==l.iteration&&(l.writingReport=!0),5<=l.iteration&&(l.finished=!0),6==l.iteration&&window.location.replace("rubrica"),i({url:"get-finished",method:"post",data:{status:l.iteration+2}}).success(function(a){a.finished&&(l.finished=!0)})})},l.getUserInfo=function(){i.post("get-my-name").success(function(a){l.myName=a.name,l.myRole=a.role})},l.selectDocument=function(a){l.selectedDocument==a||(l.selectedDocument=a,l.text=l.originalTexts[a],l.sentences=l.originalSentences[a])},l.countHighlight=function(){//console.log(self.highlight);
return null!=l.highlight&&l.highlight.reduce(function(b,c){return b.concat(c)},[]).reduce(function(c,a){return a?c+1:c},0)},l.getDocuments=function(){i({method:"post",url:"get-semantic-documents"}).success(function(a){l.documents=a,0<l.documents.length&&(l.processDocuments(),l.selectDocument(0),l.getUnits())})},l.processDocuments=function(){l.highlight=[],l.disabledSents=[],l.originalTexts=[],l.originalSentences=[];for(var a,b=0;b<l.documents.length;b++)a=l.documents[b].content,l.originalTexts.push(a.replace(/.[ ]+\n/,".\n")),l.originalSentences.push(l.originalTexts[b].match(/[^.!?\n]+[.!?\n]+/g)||[]),l.highlight.push(Array.from({length:l.originalSentences[b].length},function(){return!1})),l.disabledSents.push(Array.from({length:l.originalSentences[b].length},function(){return!1}));console.log(l.originalSentences)},l.clearDisabledSents=function(){if(l.disabledSents)for(var a=0;a<l.disabledSents.length;a++)for(var b=0;b<l.disabledSents[a].length;b++)l.disabledSents[a][b]=!1},l.processUnits=function(){l.clearDisabledSents();for(var b=0;b<l.units.length;b++)for(var c=0;c<l.units[b].sentences.length;c++){var g=l.units[b].docs[c],f=l.units[b].sentences[c];l.disabledSents[g][f]=!0}console.table(l.disabledSents)},l.getUnits=function(){var a=3==l.iteration?"get-team-sync-units":"get-semantic-units";i({method:"post",url:a,data:{iteration:l.iteration}}).success(function(a){l.units=a,l.processUnits()}),1<l.iteration&&i({method:"post",url:"get-team-semantic-units",data:{iteration:1}}).success(function(a){l.unitsIter1=a}),3<l.iteration&&i({method:"post",url:"get-team-sync-units",data:{iteration:3}}).success(function(a){l.unitsIter3=a})},l.getHgSents=function(){return l.highlight.map(function(b){return b.map(function(c,a){return[c,a]}).filter(function(a){return a[0]}).map(function(a){return a[1]})}).reduce(function(c,a){return c.concat(a)},[])},l.getHgDocs=function(){return l.highlight.map(function(c,b){return c.map(function(c,a){return[c,a]}).filter(function(a){return a[0]}).map(function(){return b})}).reduce(function(c,a){return c.concat(a)},[])},l.addSemUnit=function(c){if(3!=l.iteration||l.leader){if(c.edit&&l.toggleEdit(-1,c),3==l.iteration&&(null==c.comment||0==c.comment.length))return void g.error("Debe ingresar un comentario.");var a=3==l.iteration?"add-sync-semantic-unit":"add-semantic-unit";null!=c.id&&(a="update-semantic-unit");var e={id:c.id,comment:c.comment,sentences:c.sentences,docs:c.docs,iteration:l.iteration,uidoriginal:l.originalLeader};console.log(e),i({method:"post",url:a,data:e}).success(function(a){c.dirty=!1,null==c.id&&(c.id=a.id),l.sent[c.id]=!0,3==l.iteration&&l.updateSignal()})}},l.updateSignal=function(){i({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},l.takeControl=function(){i({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),l.updateSignal()})},l.addEmptyUnit=function(){if(-1!=l.editing)return void g.error("Debe terminar de editar la unidad actual para editar otra.");l.units.push({id:null,comment:"",sentences:l.getHgSents(),status:"unsaved",docs:l.getHgDocs()});//console.log(self.units);
var a=l.units.length-1;l.toggleEdit(a,l.units[a])},l.finishState=function(){if(!l.finished){if(3>=l.iteration){if(0==l.units.length)return void g.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!l.areAllUnitsSync())return void g.error("Hay unidades sem\xE1nticas que no han sido enviadas")}4==l.iteration&&l.shared.sendReport();var b=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(b){var a={status:l.iteration+2};i({url:"record-finish",method:"post",data:a}).success(function(){l.hasFinished=!0,l.finished=!0,console.log("FINISH"),3==l.iteration&&l.updateSignal()})}}},l.areAllUnitsSync=function(){return l.units.every(function(a){return!a.dirty})},l.toggleEdit=function(c,a){return 3!=l.iteration||l.leader?-1==l.editing||a.edit?a.edit&&0==l.countHighlight()?void g.error("Debe seleccionar al menos una unidad sem\xE1ntica"):void(a.edit?(a.sentences=l.getHgSents(),a.docs=l.getHgDocs(),l.fillUnitDisabled(a,!0),a.edit=!1,l.editing=-1,l.unselectAllHighlights()):(a.edit=!0,l.editing=c,l.fillHighlightByUnit(a),l.fillUnitDisabled(a,!1),a.dirty=!0)):void g.error("Debe terminar de editar la unidad actual para editar otra."):void 0},l.fillUnitDisabled=function(c,d){for(var a=0;a<c.sentences.length;a++){var g=c.docs[a],e=c.sentences[a];l.disabledSents[g][e]=d}},l.startView=function(c){l.unitsIter1&&l.unitsIter1.forEach(function(a){a.viewing=!1}),l.unitsIter3&&l.unitsIter3.forEach(function(a){a.viewing=!1}),c.viewing=!0;for(var d=l.selectedDocument,a=1;a<=l.documents.length&&(l.views={},c.sentences.filter(function(d,a){return c.docs[a]==l.selectedDocument}).forEach(function(a){l.views[a]=!0}),angular.equals(l.views,{}));a++)l.selectDocument((d+a)%l.documents.length)},l.stopView=function(a){// console.log("Stop viewing: ", unit.id);
a.viewing=!1,l.views={}},l.fillHighlightByUnit=function(c){l.unselectAllHighlights(),l.hgDocs={};for(var a,d=!0,e=0;e<c.sentences.length;e++){a=c.docs[e],l.hgDocs[a]=!0,d&&(l.selectDocument(a),d=!1);var f=c.sentences[e];l.highlight[a][f]=!0}// console.log(self.highlight);
},l.unselectAllHighlights=function(){l.hgDocs={};for(var a=0;a<l.highlight.length;a++)for(var b=0;b<l.highlight[a].length;b++)l.highlight[a][b]=!1},l.getTeamInfo=function(){i({url:"get-team-leader",method:"post"}).success(function(a){l.teamId=a.id,l.originalLeader=a.original_leader,a.leader==l.myUid?(l.leader=!0,l.followLeader=!1):(l.leader=!1,l.followLeader=!0)}),i({url:"get-team",method:"post"}).success(function(a){l.teamstr=a.map(function(a){return a.name+(a.finished?" \u2713":"")}).join(", ")})},l.getSimpleTeamInfo=function(){i({url:"get-team",method:"post"}).success(function(a){l.teamNames={},a.forEach(function(a){l.teamNames[a.id]=a.name})})},l.deleteUnit=function(a,c){if(c.edit)return void g.error("No puede eliminar una unidad que est\xE1 siendo editada");if(null!=c.id){var d={id:c.id};i({url:"delete-semantic-unit",method:"post",data:d}).success(function(){console.log("Idea deleted"),3==l.iteration&&l.updateSignal()})}for(var e=0;e<c.docs.length;e++){var f=c.docs[e],h=c.sentences[e];l.disabledSents[f][h]=!1}l.units.splice(a,1)},l.init()}]),app.controller("ReportController",["$scope","$http",function(a,e){var c=a;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var a={content:c.content};e({url:"send-report",method:"post",data:a}).success(function(a){"ok"==a.status&&(c.lastSent=new Date,c.misc.reportDirty=!1)})},c.shared.sendReport=c.sendReport,c.getReport=function(){e({url:"get-my-report",method:"post"}).success(function(a){"ok"==a.status&&(c.content=a.content,c.idReport=a.id)})},c.getReport()}]);var indexById=function(a,c){return a.findIndex(function(a){return a.id==c})};
