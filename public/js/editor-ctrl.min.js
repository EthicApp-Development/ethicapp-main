"use strict";var app=angular.module("Editor",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("EditorController",["$scope","$http","$timeout","$socket","Notification",function(a,b,c,d,f){var g=a;g.iteration=0,g.myUid=-1,g.documents=[],g.selections=[],g.selectedDocument=0,g.numPages=0,g.ansIter1={},g.ansIter2={},g.sideTab=0,g.docIdx={},g.writingReport=!1,g.followLeader=!1,g.leader=!1,g.finished=!1,g.teamId=-1,g.reportIdeas={},g.shared={},g.iterationNames=["Lectura","Individual","Grupal An\xF3nimo","Grupal"],g.sesStatusses=["Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],g.tabOptions=["Actual"],rangy.init(),g.applier=rangy.createClassApplier("highlight"),g.secondaryApplier=rangy.createClassApplier("highlight-secondary"),g.init=function(){g.getSesInfo(),d.on("stateChange",function(m){console.log("SOCKET.IO",m),m.ses==g.sesId&&window.location.reload()}),d.on("updateTeam",function(m){g.teamId==m.tmid&&(!g.leader&&g.getIdeas(),g.getTeamInfo())})},g.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(m){g.iteration=m.iteration,g.myUid=m.uid,g.sesName=m.name,g.sesId=m.id,g.sesDescr=m.descr,g.sesSTime=null==m.stime?null:new Date(m.stime),b({url:"get-documents",method:"post"}).success(function(n){g.documents=n,n.forEach(function(o,q){g.docIdx[o.id]=q}),g.renderAll()}),b({url:"data/instructions.json",method:"get"}).success(function(n){g.instructions=n}),3==g.iteration&&g.getTeamInfo(),5<=g.iteration&&(g.finished=!0),b({url:"get-finished",method:"post",data:{status:g.iteration+2}}).success(function(n){n.finished&&(g.finished=!0)})})},g.finishState=function(){if(0==g.iteration){var n={status:g.iteration+2};return void b({url:"record-finish",method:"post",data:n}).success(function(){g.hasFinished=!0,g.finished=!0,console.log("FINISH")})}if(!g.finished){if(g.selections.length<g.documents.length)return void f.error("No hay suficientes ideas fuerza para terminar la actividad");if(!g.areAllIdeasSync())return void f.error("Hay ideas fuerza que no han sido enviadas");var m=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(m){g.setSelOrder();var n={status:g.iteration+2};b({url:"record-finish",method:"post",data:n}).success(function(){g.hasFinished=!0,g.finished=!0,console.log("FINISH")})}}},g.areAllIdeasSync=function(){for(var n,m=0;m<g.selections.length;m++)if(n=g.selections[m],"unsaved"==n.status||"dirty"==n.status)return!1;return!0},g.getTeamInfo=function(){b({url:"get-team-leader",method:"post"}).success(function(m){g.teamId=m.id,g.originalLeader=m.original_leader,m.leader==g.myUid?(g.leader=!0,g.followLeader=!1):(g.leader=!1,g.followLeader=!0)}),b({url:"get-team",method:"post"}).success(function(m){g.teamstr=m.map(function(n){return n.name+(n.finished?" \u2713":"")}).join(", ")})},g.setTab=function(m){g.sideTab=m},g.selectText=function(){var m=window.getSelection(),n=rangy.serializeSelection(window,!0,$("#pdf-canvas-"+g.selectedDocument)[0]),o={text:m.toString(),length:m.toString().length,serial:n,document:g.selectedDocument,comment:"",expanded:!0,status:"unsaved"};return 50<o.length?void f.warning("El texto es muy largo para ser usado como una idea fuerza"):2>o.length?void f.warning("No ha seleccionado un texto para ser usado como una idea fuerza"):void(g.highlightSerial(o.serial,o.document),g.selections.push(o))},g.goToSerial=function(m,n,o){o=null==o?".highlight":o,g.selectedDocument=n;var q=angular.element(o);q=q.filter(function(r,s){return s.innerHTML==m}),console.log(q),0<q.length&&c(function(){return q[0].scrollIntoView()},100)},g.highlightSerial=function(m,n,o){console.log(m,n),o=null==o?g.applier:o;try{o.applyToRange(rangy.deserializeRange(m,$("#pdf-canvas-"+n)[0],document))}catch(q){console.log(m+" no se pudo highlightear!",q)}},g.unhighlightSerial=function(){console.log("TODO")},g.renderAll=function(){g.numPages=0,g.documents.forEach(function(m,n){j(m.path,n)})},g.selectPDF=function(m){g.selectedDocument=m},g.getIdeas=function(){var m={iteration:Math.min(3,g.iteration)},n=3==m.iteration?"get-team-sync-ideas":"get-ideas";b({url:n,method:"post",data:m}).success(function(o){g.selections=[],o.forEach(function(q){var r={id:q.id,text:q.content,serial:q.serial,document:h(g.documents,q.docid),comment:q.descr,expanded:!1,status:"saved"};g.highlightSerial(r.serial,r.document),g.selections.push(r)})}),1<g.iteration&&(g.tabOptions=[{name:"Individual",idx:1},{name:"Reelaboraci\xF3n An\xF3nima",idx:0}],b({url:"get-team-ideas",method:"post",data:{iteration:1}}).success(function(o){g.ansIter1={},o.forEach(function(q){g.ansIter1[q.uid]=g.ansIter1[q.uid]||[],g.ansIter1[q.uid].push(q),g.highlightSerial(q.serial,g.docIdx[q.docid],g.secondaryApplier)})})),2<g.iteration&&(g.tabOptions=[{name:"Individual",idx:1},{name:"Reelaboraci\xF3n An\xF3nima",idx:2},{name:"Reelaboraci\xF3n Grupal",idx:0}],b({url:"get-team-ideas",method:"post",data:{iteration:2}}).success(function(o){g.ansIter2={},o.forEach(function(q){g.ansIter2[q.uid]=g.ansIter2[q.uid]||[],g.ansIter2[q.uid].push(q),g.highlightSerial(q.serial,g.docIdx[q.docid],g.secondaryApplier)})})),4==g.iteration?g.writingReport=!0:5==g.iteration&&window.location.replace("rubrica")},g.sendIdea=function(m){if(3!=g.iteration||g.leader){var n={text:m.text,comment:m.comment,serial:m.serial,docid:g.documents[m.document].id,iteration:g.iteration,uidoriginal:g.originalLeader};if("unsaved"==m.status){var o=3==g.iteration?"send-team-idea":"send-idea";b({url:o,method:"post",data:n}).success(function(q){"ok"==q.status&&(m.expanded=!1,m.status="saved",m.id=q.id),3==g.iteration&&g.updateSignal()})}else"dirty"==m.status&&null!=m.id&&(n.id=m.id,b({url:"update-idea",method:"post",data:n}).success(function(o){"ok"==o.status&&(m.expanded=!1,m.status="saved"),3==g.iteration&&g.updateSignal()}))}},g.updateSignal=function(){b({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},g.deleteIdea=function(m,n){if(null!=m.id){var o={id:m.id};b({url:"delete-idea",method:"post",data:o}).success(function(q){"ok"==q.status&&(g.selections.splice(n,1),g.unhighlightSerial(m.serial,g.docIdx[m.docid])),g.updateSignal()})}else g.selections.splice(n,1),g.unhighlightSerial(m.serial,g.docIdx[m.docid]);g.uncopyAllIdeas()},g.copyIdea=function(m){if(console.log(m),!(null==m||null!=m.copied&&m.copied||g.selections.length>=3*g.documents.length)){var n={text:m.content,length:m.content.length,serial:m.serial,document:g.docIdx[m.docid],comment:m.descr,expanded:!0,status:"unsaved"};g.selections.push(n),m.copied=!0}},g.takeControl=function(){b({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),g.updateSignal()})},g.selTextChange=function(m){m.status="saved"==m.status?"dirty":m.status},g.checkAllSync=function(){return 0==g.selections.filter(function(m){return"saved"!=m.status}).length},g.setSelOrder=function(){if(!g.checkAllSync())return void f.warning("Hay ideas que no han sido enviadas.");var m=g.selections.map(function(o){return o.id});b({url:"set-ideas-orden",method:"post",data:{orden:m}}).success(function(o){"ok"==o.status&&console.log("Order saved")})},g.uncopyAllIdeas=function(){if(null!=g.ansIter1)for(var m in g.ansIter1)g.ansIter1[m].forEach(function(n){n.copied=!1});if(null!=g.ansIter2)for(var m in g.ansIter2)g.ansIter2[m].forEach(function(n){n.copied=!1});console.log(g.ansIter1)};var h=function arrayIndexOfId(m,n){return m.reduce(function(o,q,r){return q.id==n?r:o},-1)},j=function loadPdf(m,n){PDFJS.disableWorker=!0;var o=PDFJS.getDocument(m);o.then(function(q){return k(q,n)})},k=function renderPdf(m,n){for(var q,o=1;o<=m.numPages;o++)q=m.getPage(o).then(function(r){return l(r,n)}),g.numPages+=1},l=function renderPage(m,n){var q=m.getViewport(1.3),r=$("<canvas></canvas>"),s=r.get(0),t=s.getContext("2d");s.height=q.height,s.width=q.width;var v=$("#pdf-canvas-"+n);v.css("height",s.height+"px").css("width",s.width+"px"),v.append(r);var w=r.offset(),x=jQuery("<div></div>").addClass("textLayer").css("height",q.height+"px").css("width",q.width+"px");v.append(x),m.getTextContent({normalizeWhitespace:!0}).then(function(y){var z=new TextLayerBuilder(x.get(0),0);z.setTextContent(y);m.render({canvasContext:t,viewport:q,textLayer:z}).then(function(){g.numPages-=1,0==g.numPages&&(g.getIdeas(),$(".textLayer").html(function(){return this.innerHTML.replace(/\t/g," ")}))})})};g.toggleUseIdea=function(m){g.reportIdeas[m]=!(null!=g.reportIdeas[m])||!g.reportIdeas[m]},g.shared.getReportIdeas=function(){var m={repid:g.shared.idReport};b({url:"get-report-ideas",method:"post",data:m}).success(function(n){n.forEach(function(o){g.reportIdeas[o.ideaid]=!0})})},g.shared.sendReportIdeas=function(){if(null!=g.shared.idReport){var m={repid:g.shared.idReport};b({url:"clear-report-ideas",method:"post",data:m}).success(function(n){if("ok"==n.status)for(var o in g.reportIdeas)g.reportIdeas[o]&&b({url:"send-report-idea",method:"post",data:{repid:g.shared.idReport,iid:o}}).success(function(){console.log("Report idea sent")})})}else b({url:"get-my-report",method:"post"}).success(function(m){"ok"==m.status&&(g.shared.idReport=m.id,g.shared.sendReportIdeas())})},g.init()}]),app.controller("ReportController",["$scope","$http",function(a,b){var c=a;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var d={content:c.content};b({url:"send-report",method:"post",data:d}).success(function(f){"ok"==f.status&&(c.lastSent=new Date,c.shared.sendReportIdeas())})},c.getReport=function(){b({url:"get-my-report",method:"post"}).success(function(d){"ok"==d.status&&(c.content=d.content,c.shared.idReport=d.id,c.shared.getReportIdeas())})},c.getReport()}]);
