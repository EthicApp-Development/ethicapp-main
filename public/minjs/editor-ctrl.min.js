"use strict";var app=angular.module("Editor",["dndLists"]);app.controller("EditorController",["$scope","$http","$timeout",function(a,b,c){var d=a;d.documents=[],d.selections=[],d.selectedDocument=0,rangy.init(),d.applier=rangy.createClassApplier("highlight"),d.init=function(){b({url:"get-documents",method:"post"}).success(function(f){d.documents=f,d.renderAll(),c(d.getIdeas,9e3)})},d.selectText=function(){var f=window.getSelection(),g=rangy.serializeSelection(window,!0,$("#pdf-canvas-"+d.selectedDocument)[0]),h={text:f.toString(),length:f.toString().length,serial:g,document:d.selectedDocument,comment:"",expanded:!0,status:"unsaved"};2>h.length||50<h.length||(d.highlightSerial(h.serial,h.document),d.selections.push(h))},d.highlightSerial=function(f,g){d.applier.applyToRange(rangy.deserializeRange(f,$("#pdf-canvas-"+g)[0],document))},d.renderAll=function(){d.documents.forEach(function(f,g){loadPdf(f.path,g)})},d.selectPDF=function(f){d.selectedDocument=f},d.getIdeas=function(){b({url:"get-ideas",method:"post"}).success(function(f){d.selections=[],f.forEach(function(g){var h={id:g.id,text:g.content,serial:g.serial,document:arrayIndexOfId(d.documents,g.docid),comment:g.descr,expanded:!1,status:"saved"};d.highlightSerial(h.serial,h.document),d.selections.push(h)})})},d.sendIdea=function(f){var g={text:f.text,comment:f.comment,serial:f.serial,docid:d.documents[f.document].id};"unsaved"==f.status?b({url:"send-idea",method:"post",data:g}).success(function(h){"ok"==h.status&&(f.expanded=!1,f.status="saved",f.id=h.id)}):"dirty"==f.status&&null!=f.id&&(g.id=f.id,b({url:"update-idea",method:"post",data:g}).success(function(h){"ok"==h.status&&(f.expanded=!1,f.status="saved")}))},d.selTextChange=function(f){f.status="saved"==f.status?"dirty":f.status},d.checkAllSync=function(){return 0==d.selections.filter(function(f){return"saved"!=f.status}).length},d.setSelOrder=function(){if(d.checkAllSync()){var _f=d.selections.map(function(g){return g.id});b({url:"set-ideas-orden",method:"post",data:{orden:_f}}).success(function(g){"ok"==g.status&&console.log("Order saved")})}},d.init()}]);var arrayIndexOfId=function arrayIndexOfId(a,b){return a.reduce(function(c,d,f){return d.id==b?f:c},-1)},loadPdf=function loadPdf(a,b){PDFJS.disableWorker=!0;var c=PDFJS.getDocument(a);c.then(function(d){return renderPdf(d,b)})},renderPdf=function renderPdf(a,b){for(var c=1;c<=a.numPages;c++)a.getPage(c).then(function(d){return renderPage(d,b)})},renderPage=function renderPage(a,b){var c=a.getViewport(1.3),d=$("<canvas></canvas>"),f=d.get(0),g=f.getContext("2d");f.height=c.height,f.width=c.width;var h=$("#pdf-canvas-"+b);h.css("height",f.height+"px").css("width",f.width+"px"),h.append(d),d.offset();var j=jQuery("<div></div>").addClass("textLayer").css("height",c.height+"px").css("width",c.width+"px");h.append(j),a.getTextContent().then(function(k){var l=new TextLayerBuilder(j.get(0),0);l.setTextContent(k),a.render({canvasContext:g,viewport:c,textLayer:l})})};